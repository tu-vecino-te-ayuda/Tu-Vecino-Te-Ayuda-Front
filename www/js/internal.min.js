function createHelp(e,t){$.ajax({type:"POST",url:server+"api/help-requests",data:e,dataType:"json",headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok: "),console.log(e),$("#createHelp").modal("hide"),setTimeout(location.reload(),1500)}).fail(function(e){console.log("Error: "),console.log(e)})}function getAsocUsers(){$.ajax({type:"GET",url:server+"api/user/associates",headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok lista usuarios: "),console.log(e),e.data.length>0?generateTableMyUsers(e.data):$("#tablecontent-users").append('<tr><td colspan="7" class="text-center">Por ahora no tienes voluntarios enlazados, gracias por tu colaboración y ¡nos vemos mañana!</td></tr>')}).fail(function(e){console.log("Error: "),console.log(e)})}function getUnassignedHelp(){$.ajax({type:"GET",url:server+"api/help-requests/pending",headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok: "),console.log(e),e.data.length>0?generateTableUnassigned(e.data):$("#tablecontent-unassigned").append('<tr><td colspan="7" class="text-center">Por ahora no tenemos solicitudes de ayuda en tu zona, gracias por tu colaboración y ¡nos vemos mañana!</td></tr>')}).fail(function(e){console.log("Error: "),console.log(e)})}function getOwnHelp(){$.ajax({type:"GET",url:server+"api/help-requests",headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok: "),console.log(e),e.data.length>0?generateTableOwn(e.data):(1==user_type_id&&$("#firstTime").modal("show"),$("#tablecontent-own").append('<tr><td colspan="7" class="text-center">Por ahora no tienes solicitudes de ayuda en tu lista ¿Empezamos?</td></tr>'))}).fail(function(e){console.log("Error: "),console.log(e)})}function saveData(e,t){$.ajax({type:"PUT",url:server+"api/user/update",data:e,dataType:"json",headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok: "),console.log(e),$("#editData").modal("hide"),updateUserSession(e.user),setTimeout(location.reload(),1500)}).fail(function(e){console.log("Error: "),console.log(e)})}function verifyData(e,t){$.ajax({type:"POST",url:server+"api/user/verify",data:e,dataType:"json",headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok: "),console.log(e)}).fail(function(e){console.log("Error: "),console.log(e)})}function enrollAsoc(e){$.ajax({type:"POST",url:server+"api/user/association/join/"+e,headers:{Authorization:"Bearer "+token}}).then(function(t){console.log("Ok: "),console.log(t),$("#enrollAsoc").modal("hide"),addAsocSession(e),setTimeout(location.reload(),1500)}).fail(function(e){console.log("Error: "),console.log(e)})}function detachAsoc(e){$.ajax({type:"DELETE",url:server+"api/user/association/detach/"+e,headers:{Authorization:"Bearer "+token}}).then(function(t){console.log("Ok: "),console.log(t),$("#enrollAsoc").modal("hide"),deleteAsocSession(e),setTimeout(location.reload(),1500)}).fail(function(e){console.log("Error: "),console.log(e)})}function aceptHelp(e){$.ajax({type:"POST",url:server+"api/help-requests/accept/"+e,headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok: "),console.log(e),$("#helpNow").modal("hide"),setTimeout(location.reload(),1500)}).fail(function(e){console.log("Error: "),console.log(e)})}function getAsocList(){$.ajax({type:"GET",url:server+"api/public/associations",headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok asoc: "),console.log(e),associations=e.data,e.data.length>0?$.each(e.data,function(e,t){$("#asoc_id").append($("<option>",{value:t.id,text:t.corporate_name}))}):$("#tablecontent").append("")}).fail(function(e){console.log("Error: "),console.log(e)})}function deleteAcceptedHelps(e){$.ajax({type:"DELETE",url:server+"api/help-requests/revert/"+e,headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok: "),console.log(e),setTimeout(location.reload(),1500)}).fail(function(e){console.log("Error: "),console.log(e)})}function deleteCreatedHelps(e){$.ajax({type:"DELETE",url:server+"api/help-requests/"+e,headers:{Authorization:"Bearer "+token}}).then(function(e){console.log("Ok: "),console.log(e),setTimeout(location.reload(),1500)}).fail(function(e){console.log("Error: "),console.log(e)})}function generateTableUnassigned(e){var t="";$.each(e,function(e,a){var o="";o=a.assigned_user_count>0?'<i class="fa fa-check-circle" title="Voluntario Asignado"></i>':'<i class="fa fa-minus-square" title="Pendiente de Asignar"></i>',t=t+'<tr><td class="text-center text-warning"><h6>'+o+'<span class="badge badge-light" title="Voluntarios Asignados">'+a.assigned_user_count+'</span></h6></td><th scope="row">'+a.created_at+'</th><td style="width: 300px;">'+help_request_types[a.help_request_type.id]+"<br><div><textarea disabled>Comentario: "+a.message+"</textarea></td><td>"+obtainState(a.user.state)+"</td><td>"+obtainCity(a.user.city)+"</td><td>"+a.user.zip_code+'</td><td><button type="button" class="btn btn-outline-success btn-sm"  data-toggle="modal" data-target="#helpNow" data-whatever="'+a.id+'">¡Yo te Ayudo!</button></td></tr>'}),$("#tablecontent-unassigned").append(t)}function generateTableOwn(e){var t="",a="";$.each(e,function(e,o){var s=o.accepted_at?o.accepted_at:"Pendiente de Asignar",n="",r="",i="";1==user_type_id&&(0==o.assigned_user_id.length?(n="---",r="---",i="---"):$.each(o.assigned_user_id,function(e,t){n=t.name+"<br>",r=t.phone,i=t.email+"<br>"})),1==user_type_id&&(a='<span class="delete-help" onclick="deleteCreatedHelps('+o.id+')"><i class="fa fa-trash" title="Eliminar solicitud de ayuda" ></i></span>'),2==user_type_id&&(n="¡Tu estas ayudando!",r="---",i="---",a='<span class="detach-help" onclick="deleteAcceptedHelps('+o.id+')"><i class="fa fa-trash" title="Declinar solicitud de ayuda"></i></span>'),t=t+'<tr><th scope="row"><small>'+o.created_at+"<br>"+s+'</small></th><td  style="width: 300px;">'+help_request_types[o.help_request_type.id]+"<br><div><textarea disabled>Comentario: "+o.message+"</textarea></td><td>"+o.user.address+" <br>"+obtainCity(o.user.city)+", "+obtainState(o.user.state)+" ("+o.user.zip_code+")</td><td>"+o.user.name+" <br> "+n+"</td><td>"+o.user.phone+" / "+o.user.email+" <br> "+r+" / "+i+'</td><td class="text-center text-secondary"><h6>'+a+"</h6></td></tr>"}),$("#tablecontent-own").append(t)}function generateTableMyAsoc(e){var t="";$.each(e,function(e,a){t=t+'<tr><th scope="row">'+a.corporate_name+"</th><td>"+a.email+"</td><td>"+a.phone+"</td><td>"+a.activity_areas_id.name+"</td><td>"+obtainState(a.state)+"</td><td>"+obtainCity(a.city)+"</td></tr>"}),$("#tablecontent-asoc-own").append(t)}function generateTableMyUsers(e){var t="";$.each(e,function(e,a){t=t+'<tr><th scope="row">'+a.name+"</th><td>"+a.email+"</td><td>"+a.phone+"</td><td>"+a.nearby_areas_id.name+"</td><td>"+obtainState(a.state)+"</td><td>"+obtainCity(a.city)+"</td><td>"+a.zip_code+"</td></tr>"}),$("#tablecontent-users").append(t)}function loadUserData(){var e=$.parseJSON(sessionStorage.getItem("userData"));switch(null===e&&(window.location.href="./"),token=e.token,user_type_id=e.user.user_type_id.id,console.log(e),$("#user-name").append(e.user.name),$("#user-city").append(obtainCity(e.user.city)),$("#user-state").append(obtainState(e.user.state)),$("#address").val(e.user.address),$("#zip_code").val(e.user.zip_code),e.user.corporate_name&&$("#asoc-name").append("(<b>"+e.user.corporate_name+"</b>)"),"javioreto@gmail.com"==e.user.email&&$("#verify").modal("show"),user_type_id){case 1:$("#btn-showPhone").removeClass("d-none"),$("#nearby_areas_id").hide(),$("#btn-createHelp").removeClass("d-none"),$("#sect-own-results").removeClass("d-none");break;case 2:$("#btn-enrollAsoc").removeClass("d-none"),e.user.associations.length>0&&($("#sect-asoc").removeClass("d-none"),generateTableMyAsoc(e.user.associations),$.each(e.user.associations,function(e,t){$("#associations-delete").append('<span class="ml-2">'+t.corporate_name+' <a href="javascript:detachAsoc('+t.id+')" title="Eliminar relación"><i class="fa fa-trash"></i></a></span>')})),$("#downloadPdf").removeClass("d-none"),$("#sect-results").removeClass("d-none"),$("#sect-own-results").removeClass("d-none"),$(".detach-help").css("display","block"),$('#nearby_areas_id option[value="'+e.user.nearby_areas_id.id+'"]').attr("selected","selected");break;case 3:getAsocUsers(),$("#nearby_areas_id").hide(),$("#btn-editData").removeClass("d-none"),$("#sect-users").removeClass("d-none"),$("#sect-results").removeClass("d-none"),$(".delete-help").css("display","block"),$("#helpNow .modal-body").html("<p>Como Asociación no puede hacerse cargo directamente de una solicitud, pero puede <b>gestionar a sus voluntarios</b> para que atiendan estas peticiones.</p>"),$("#helpNow .btn-success").hide(),$('#nearby_areas_id option[value="'+e.user.nearby_areas_id.id+'"]').attr("selected","selected")}$("#sect-loader").addClass("d-none");let t=$(".ayuda-provincia"),a=$(".ayuda-ciudad");$.each(provincias,function(a,o){e.user.state==o.id?t.append($("<option></option>").attr("value",o.id).attr("selected","selected").text(o.nm)):t.append($("<option></option>").attr("value",o.id).text(o.nm))}),$.each(ciudades,function(t,o){o.id.substring(0,2)==e.user.state&&(e.user.city==o.id?a.append($("<option></option>").attr("value",o.id).attr("selected","selected").text(o.nm)):a.append($("<option></option>").attr("value",o.id).text(o.nm)))})}function deleteAsocSession(e){var t=$.parseJSON(sessionStorage.getItem("userData")),a=[];$.each(t.user.associations,function(t,o){o.id!=e&&a.push(o)}),t.user.associations=a,sessionStorage.setItem("userData",JSON.stringify(t))}function addAsocSession(e){var t=$.parseJSON(sessionStorage.getItem("userData")),a=[];$.each(t.user.associations,function(e,t){a.push(t)}),console.log(a),$.each(associations,function(t,o){o.id!=e||a.push(o)}),t.user.associations=a,sessionStorage.setItem("userData",JSON.stringify(t))}function updateUserSession(e){var t=$.parseJSON(sessionStorage.getItem("userData"));t.user=e,sessionStorage.setItem("userData",JSON.stringify(t))}$(document).ready(function(){loadUserData(),getOwnHelp(),getUnassignedHelp(),getAsocList(),$("#create-help").click(function(e){var t={help_request_type_id:$("#help_request_type_id option:selected").val(),message:$("#message").val()};createHelp(t,e)}),$("#helpNow").on("show.bs.modal",function(e){var t=$(e.relatedTarget),a=t.data("whatever");actual_help_id=a}),$("#helpNowButton").click(function(e){aceptHelp(actual_help_id)}),$("#save-enroll").click(function(e){enrollAsoc($("#asoc_id").val())}),$("#save-data").click(function(e){var t={};$.each(document.forms["form-edit"].elements,function(e,a){t[a.name]=a.value}),saveData(t),e.preventDefault()}),$("#verify-data").click(function(e){var t={};$.each(document.forms["form-verify"].elements,function(e,a){"file-image"!=a.name&&(t[a.name]=a.value)}),verifyData(t),e.preventDefault()});var e=Math.floor(Math.random()*$("#carouselThanks .carousel-indicators li").length);$("#carouselThanks").carousel(e),$("#carouselThanks").carousel("next"),$("#file-image").change(function(e){var t=e.target.files[0],a=new FileReader;a.onloadend=function(){var e=a.result.replace(/^data:.+;base64,/,"");$("#image").val(e)},a.readAsDataURL(t)})});var actual_help_id=null,token=null,user_type_id=null,associations=[],loader="<div class='lds-ellipsis'><div></div><div></div><div></div><div></div></div>";